<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>CyberQuest: Blue Protocol</title>
    <style>
        :root {
            --bg: #050b18; --accent: #00d2ff; --secondary: #9d00ff; --text: #e0e6ed;
            --card-bg: rgba(13, 25, 48, 0.95); --neon-shadow: 0 0 15px rgba(0, 210, 255, 0.4); --error: #ff4b2b;
        }

        body, html {
            margin: 0; padding: 0; background-color: var(--bg); color: var(--text);
            font-family: 'Segoe UI', sans-serif; overflow-x: hidden; min-height: 100vh;
        }

        #matrix-canvas { position: fixed; top: 0; left: 0; z-index: 0; opacity: 0.5; pointer-events: none; }

        .container {
            position: relative; z-index: 1; width: 92%; max-width: 500px;
            background: var(--card-bg); margin: 20px auto; padding: 30px 20px;
            border-radius: 20px; border: 1px solid var(--secondary);
            box-shadow: 0 0 30px rgba(157, 0, 255, 0.2); backdrop-filter: blur(10px); text-align: center;
        }

        .screen { display: none; animation: fadeIn 0.4s ease-out; }
        .active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }

        h1, h2 { color: var(--accent); text-transform: uppercase; letter-spacing: 2px; margin-top: 0; }
        .attempts-badge { display: inline-block; padding: 4px 12px; border-radius: 20px; background: var(--secondary); font-size: 0.8rem; font-weight: bold; margin-bottom: 15px; }

        .welcome-msg { margin-bottom: 20px; font-size: 0.9rem; border-left: 3px solid var(--secondary); padding: 10px 15px; text-align: left; background: rgba(255,255,255,0.05); }

        select, button { width: 100%; padding: 16px; border-radius: 12px; font-size: 1rem; margin-top: 10px; cursor: pointer; border: 1px solid var(--secondary); box-sizing: border-box; }
        select { background: #112240; color: white; outline: none; }
        button { background: rgba(157, 0, 255, 0.15); color: white; font-weight: bold; transition: 0.2s; }
        button:hover:not(:disabled) { background: var(--secondary); box-shadow: 0 0 15px var(--secondary); }
        button:disabled { opacity: 0.4; cursor: not-allowed; }

        .progress-bar { height: 6px; background: #112240; margin-bottom: 25px; border-radius: 3px; overflow: hidden; }
        #progress-fill { height: 100%; background: linear-gradient(90deg, var(--accent), var(--secondary)); width: 0%; transition: width 0.3s; }

        .lb-tabs { display: flex; gap: 5px; margin-top: 25px; background: rgba(0, 0, 0, 0.4); padding: 5px; border-radius: 12px; border: 1px solid var(--secondary); }
        .tab-btn { flex: 1; padding: 10px; font-size: 0.8rem; border-radius: 8px; cursor: pointer; text-align: center; color: #8b949e; }
        .tab-btn.active { background: var(--secondary); color: white; box-shadow: 0 0 10px var(--secondary); }
        
        .lb-content { margin-top: 15px; min-height: 150px; text-align: left; }
        .lb-list { display: none; }
        .lb-list.active { display: block; }
        .leader-item { display: flex; justify-content: space-between; padding: 10px; border-bottom: 1px solid rgba(139, 92, 246, 0.2); font-size: 0.9rem; }
    </style>
</head>

<body>
    <canvas id="matrix-canvas"></canvas>

    <div class="container">
        <div id="start-screen" class="screen active">
            <h1>CyberQuest</h1>
            <div id="attempts-ui" class="attempts-badge">–°–ø—Ä–æ–±–∏: 3 / 3</div>
            <div id="welcome-container"></div>
            
            <div style="text-align: left; margin: 20px 0;">
                <label style="font-size: 0.8rem; color: var(--accent); margin-left: 5px;">–û–ë–ï–†–ò –ö–û–ú–ê–ù–î–£:</label>
                <select id="team-select">
                    <option value="">–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –∫–æ–º–∞–Ω–¥...</option>
                </select>
            </div>
            
            <button id="start-btn" onclick="startQuiz()" style="background: var(--secondary)">–†–û–ó–ü–û–ß–ê–¢–ò –ú–Ü–°–Ü–Æ</button>
        </div>

        <div id="waiting-screen" class="screen">
            <h2 style="color:var(--accent)">–û–ß–Ü–ö–£–í–ê–ù–ù–Ø –ö–û–ú–ê–ù–î–ò–†–ê...</h2>
            <div class="loader"></div>
            <p>–¢–∏ –∑–∞ —Å—Ç–æ–ª–æ–º. –©–æ–π–Ω–æ –≤—á–∏—Ç–µ–ª—å –Ω–∞—Ç–∏—Å–Ω–µ "–°–¢–ê–†–¢", –ø–æ—á–Ω–µ—Ç—å—Å—è –±–∏—Ç–≤–∞!</p>
        </div>

        <div id="quiz-ui" class="screen">
            <div class="progress-bar"><div id="progress-fill"></div></div>
            <div id="quiz-content"></div>
        </div>

        <div id="result-screen" class="screen">
            <h2>–î–æ—Å—Ç—É–ø –¥–æ–∑–≤–æ–ª–µ–Ω–æ</h2>
            <div class="nickname-display" id="nick-display" style="font-size: 1.8rem; font-weight: bold; color: var(--accent); margin: 10px 0;"></div>
            <div id="conclusion-box" style="margin: 15px 0; padding: 12px; background: rgba(0,0,0,0.2); border-radius: 10px; border-left: 4px solid var(--secondary); text-align: left; font-size: 0.9rem;"></div>
            <p>–ë–∞–ª: <span id="final-score" style="color: var(--accent); font-weight: bold;">0</span> / 26</p>

            <div class="lb-tabs">
                <div class="tab-btn active" id="t-pl" onclick="switchTab('pl')">–ì–†–ê–í–¶–Ü</div>
                <div class="tab-btn" id="t-tm" onclick="switchTab('tm')">–ö–û–ú–ê–ù–î–ò</div>
            </div>
            <div class="lb-content">
                <div id="player-list" class="lb-list active"></div>
                <div id="team-list" class="lb-list"></div>
            </div>

            <button style="width: 100%; margin-top: 20px; background: var(--secondary);" onclick="location.reload()">–ó–ê–ù–û–í–û</button>
        </div>
    </div>

    <script>
        const API_URL = "https://europe-west3-alphahome-484017.cloudfunctions.net/manage-leaderboard";

        // --- GAME DATA ---
        const allQuestions = [
            { icon: "üîê", q: "–ü–∞—Ä–æ–ª—å 'myadmin2011' ‚Äî —Ü–µ –Ω–∞–¥—ñ–π–Ω–∏–π –∑–∞—Ö–∏—Å—Ç?", options: [{ text: "–ù—ñ, –ª–µ–≥–∫–æ –ø—ñ–¥—ñ–±—Ä–∞—Ç–∏", score: 2 }, { text: "–î–ª—è —á–æ–≥–æ—Å—å –Ω–µ–≤–∞–∂–ª–∏–≤–æ–≥–æ –ø—ñ–¥—ñ–π–¥–µ", score: 1 }, { text: "–¢–∞–∫, —Ç–∞–º —î —Ü–∏—Ñ—Ä–∏", score: 0 }] },
            { icon: "üîê", q: "–ü–∞—Ä–æ–ª—å 'F(#*28?—Ü–≤wui3' ‚Äî —Ü–µ –Ω–∞–¥—ñ–π–Ω–∏–π –∑–∞—Ö–∏—Å—Ç?", options: [{ text: "–¢–∞–∫, —Ü–µ –≤–∏–≥–ª—è–¥–∞—î –Ω–µ–∑–∞–º–Ω–æ", score: 2 }, { text: "–í—ñ–Ω —Å–∫–ª–∞–¥–Ω–∏–π, –Ω–µ –ø—ñ–¥—Ö–æ–¥–∏—Ç—å", score: 0 }] },
            { icon: "üîê", q: "–Ø–∫–∏–π PIN –∫–æ–¥ –Ω–∞ —Ç–µ–ª–µ—Ñ–æ–Ω –≤–∏–∫–ª—è–¥–∞—î –±—ñ–ª—å—à —Å–∫–ª–∞–¥–Ω–∏–º '1221' —á–∏ '3704'?", options: [{ text: "1221", score: 0 }, { text: "3704", score: 1 } ]},
            { icon: "üõ∞Ô∏è", q: "–ü—Ä–æ–ø–æ–Ω—É—é—Ç—å '–±–µ–∑–∫–æ—à—Ç–æ–≤–Ω—ñ –º–æ–Ω–µ—Ç–∏' –≤ –æ–±–º—ñ–Ω –Ω–∞ –ª–æ–≥—ñ–Ω. –¢–≤–æ—è —Ä–µ–∞–∫—Ü—ñ—è?", options: [{ text: "–ó–∞–±–ª–æ–∫—É—é —à–∞—Ö—Ä–∞—è", score: 2 }, { text: "–°–ø—Ä–æ–±—É—é, —Ä–∞–ø—Ç–æ–º –ø—Ä–∞–≤–¥–∞", score: 0 }] },
            { icon: "ü§≥", q: "–ß–∏ –º–æ–∂–Ω–∞ –ø—É–±–ª—ñ–∫—É–≤–∞—Ç–∏ —Ñ–æ—Ç–æ –∑ –¥–æ–º–∞—à–Ω—å–æ—é –∞–¥—Ä–µ—Å–æ—é?", options: [{ text: "–ù—ñ, —Ü–µ –Ω–µ–±–µ–∑–ø–µ—á–Ω–æ", score: 2 }, { text: "–¢–∞–∫, –¥—Ä—É–∑—ñ –º–∞—é—Ç—å –∑–Ω–∞—Ç–∏", score: 0 }] },
            { icon: "üëæ", q: "–ë–µ–∑–ø–µ—á–Ω–æ –∑–∞–≤–∞–Ω—Ç–∞–∂—É–≤–∞—Ç–∏ —ñ–≥—Ä–∏ –∑ –Ω–µ–æ—Ñ—ñ—Ü—ñ–π–Ω–∏—Ö —Å–∞–π—Ç—ñ–≤?", options: [{ text: "–ù—ñ, —Ç–∞–º –º–æ–∂—É—Ç—å –±—É—Ç–∏ –≤—ñ—Ä—É—Å–∏", score: 2 }, { text: "–¢–∞–∫, –≤–æ–Ω–∏ –±–µ–∑–∫–æ—à—Ç–æ–≤–Ω—ñ", score: 0 }] },
            { icon: "üß†", q: "–Ø–∫ –ø–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ –Ω–æ–≤–∏–Ω—É –≤ –º–µ—Ä–µ–∂—ñ –Ω–∞ –ø—Ä–∞–≤–¥–∏–≤—ñ—Å—Ç—å?", options: [{ text: "–ü–æ–¥–∏–≤–ª—é—Å—å –Ω–∞ –æ—Ñ—ñ—Ü—ñ–π–Ω—ñ –¥–∂–µ—Ä–µ–ª–∞", score: 2 }, { text: "–ü–æ–≤—ñ—Ä—é, —è–∫—â–æ –±–∞–≥–∞—Ç–æ –ª–∞–π–∫—ñ–≤", score: 0 }] },
            { icon: "üõ°Ô∏è", q: "–©–æ —Ç–∞–∫–µ –¥–≤–æ—Ñ–∞–∫—Ç–æ—Ä–Ω–∞ –∞–≤—Ç–µ–Ω—Ç–∏—Ñ—ñ–∫–∞—Ü—ñ—è?", options: [{ text: "–î–æ–¥–∞—Ç–∫–æ–≤–∏–π –∫–æ–¥ –ø—ñ–¥—Ç–≤–µ—Ä–¥–∂–µ–Ω–Ω—è", score: 2 }, { text: "–¶–µ –∫–æ–ª–∏ –¥–≤–∞ –ø–∞—Ä–æ–ª—ñ", score: 0 }] },
            { icon: "üï∂Ô∏è", q: "–ß–∏ –º–æ–∂–µ –Ω–µ–∑–Ω–∞–π–æ–º–µ—Ü—å –±—É—Ç–∏ –Ω–µ —Ç–∏–º, –∑–∞ –∫–æ–≥–æ —Å–µ–±–µ –≤–∏–¥–∞—î?", options: [{ text: "–¢–∞–∫, —Ü–µ —á–∞—Å—Ç–æ –±—É–≤–∞—î", score: 2 }, { text: "–ù—ñ, —Ñ–æ—Ç–æ –∂ —Å–ø—Ä–∞–≤–∂–Ω—î", score: 0 }] },
            { icon: "üì±", q: "–ü—Ä–æ–≥—Ä–∞–º–∞ '–ü–æ–≥–æ–¥–∞' —Ö–æ—á–µ –¥–æ—Å—Ç—É–ø –¥–æ –º—ñ–∫—Ä–æ—Ñ–æ–Ω–∞, —Ç–∞ –∫–∞–º–µ—Ä–∏. –¶–µ –Ω–æ—Ä–º–∞–ª—å–Ω–æ?", options: [{ text: "–ù—ñ, —Ü–µ –ø—ñ–¥–æ–∑—Ä—ñ–ª–æ", score: 2 }, { text: "–¢–∞–∫, –≤–æ–Ω–∞ —Ä–æ–∑—É–º–Ω–∞", score: 0 }] },
            { icon: "üßä", q: "–¢–∏ –∑–Ω–∞–π—à–æ–≤ —Ñ–ª–µ—à–∫—É –±—ñ–ª—è —à–∫–æ–ª–∏. –©–æ –∑ –Ω–µ—é —Ä–æ–±–∏—Ç–∏?", options: [{ text: "–í—ñ–¥–¥–∞–º –≤—á–∏—Ç–µ–ª—é, –Ω–µ –≤–º–∏–∫–∞—é—á–∏", score: 2 }, { text: "–í—Å—Ç–∞–≤–ª—é –≤ –∫–æ–º–ø", score: 0 }] },
            { icon: "üì±", q: "–¢–µ–ª–µ—Ñ–æ–Ω –ø—Ä–æ–ø–æ–Ω—É—î –ø–æ–∫—Ä–∞—â–∏—Ç–∏ –±–µ–∑–ø–µ–∫—É —É –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è—Ö", options: [{ text: "–ù–µ—Ü—ñ–∫–∞–≤–æ, –≤—ñ–¥–º—ñ–Ω–∏—Ç–∏", score: 0 }, { text: "–ü–µ—Ä–µ–π–¥—É —É –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è —Ç–∞ —É–≤—ñ–∫–Ω—É", score: 2 }, { text: "–ú–æ–∂–ª–∏–≤–æ –≤—ñ—Ä—É—Å. –ü–µ—Ä–µ–∑–∞–≤–∞–Ω—Ç–∞–∂—É", score: 0 }] },
            { icon: "üì°", q: "–ë–µ–∑–ø–µ—á–Ω–æ –≤–≤–æ–¥–∏—Ç–∏ –¥–∞–Ω—ñ –±–∞–Ω–∫—ñ–≤—Å—å–∫–æ—ó –∫–∞—Ä—Ç–∏ —á–µ—Ä–µ–∑ –≤—ñ–¥–∫—Ä–∏—Ç–∏–π Wi-Fi?", options: [{ text: "–ù—ñ, –¥–∞–Ω—ñ –º–æ–∂—É—Ç—å –≤–∫—Ä–∞—Å—Ç–∏", score: 2 }, { text: "–¢–∞–∫, —è–∫—â–æ –∑–≤'—è–∑–æ–∫ —à–≤–∏–¥–∫–∏–π", score: 0 }] },
            { icon: "‚ö°", q: "–ü–∏—à—É—Ç—å, —â–æ –∞–∫–∞—É–Ω—Ç –∑–∞–±–ª–æ–∫—É—é—Ç—å, —è–∫—â–æ –Ω–µ –ø–µ—Ä–µ–π–¥–µ—à –∑–∞ –ª—ñ–Ω–∫–æ–º –∑–∞ 5 —Ö–≤. –¶–µ..", options: [{ text: "–ú–∞–Ω—ñ–ø—É–ª—è—Ü—ñ—è —Ç–∞ —Ñ—ñ—à–∏–Ω–≥", score: 2 }, { text: "–°–ª—É–∂–±–∞ –ø—ñ–¥—Ç—Ä–∏–º–∫–∏ –ø–æ—Å–ø—ñ—à–∞—î", score: 0 }] },
            { icon: "üïµÔ∏è‚Äç‚ôÇÔ∏è", q: "–õ–∏—Å—Ç –≤—ñ–¥ '—Ç–µ—Ö–ø—ñ–¥—Ç—Ä–∏–º–∫–∏' –∑ –ø–æ—Å–∏–ª–∞–Ω–Ω—è–º mikrosoft-security.com", options: [{ text: "–¶–µ —Ñ—ñ—à–∏–Ω–≥. –ü–æ–≤—ñ–¥–æ–º–∏—Ç–∏ –ø—Ä–æ –Ω—å–æ–≥–æ", score: 2 }, { text: "–Ü–≥–Ω–æ—Ä—É—é", score: 1 }, { text: "–ö–ª—ñ–∫–Ω—É, –æ–Ω–æ–≤–∏—Ç–∏ ‚Äî –≤–∞–∂–ª–∏–≤–æ", score: 0 }] },
            { icon: "üé≠", q: "–í—ñ–¥–µ–æ –∑—ñ –∑–Ω–∞–º–µ–Ω–∏—Ç—ñ—Å—Ç—é –∑ –¥–∏–≤–Ω–∏–º–∏ –∞—Ä—Ç–µ—Ñ–∞–∫—Ç–∞–º–∏ –∑–æ–±—Ä–∞–∂–µ–Ω–Ω—è. –©–æ —Ü–µ?", options: [{ text: "–î–∏–ø—Ñ–µ–π–∫, –∑–∞—Å—Ç–µ—Ä–µ–∂—É –¥—Ä—É–∑—ñ–≤", score: 2 }, { text: "–î–∏–ø—Ñ–µ–π–∫, –ø—Ä–æ—ñ–≥–Ω–æ—Ä—É—é", score: 1 }, { text: "–ü—Ä–æ—Å—Ç–æ –ø–æ–≥–∞–Ω–∏–π –º—ñ–∫—Ä–æ—Ñ–æ–Ω", score: 0 }] },
            { icon: "üì∂", q: "–¢–∏ –≤ –ú–µ—Ç—Ä–æ. –ß–∏ –±–µ–∑–ø–µ—á–Ω–æ –ø–µ—Ä–µ–¥–∞–≤–∞—Ç–∏ —Ñ–∞–π–ª–∏ —á–µ—Ä–µ–∑ –ø—É–±–ª—ñ—á–Ω–∏–π Wi-Fi?", options: [{ text: "–ù—ñ, –Ω–µ–±–µ–∑–ø–µ—á–Ω–æ", score: 2 }, { text: "–¢–∞–∫, —Ç—ñ–ª—å–∫–∏ –∑ VPN", score: 1 }, { text: "–¢–∞–∫, –∑—Ä—É—á–Ω–æ", score: 0 }] },
            { icon: "üì∏", q: "–ë–µ–∑–ø–µ—á–Ω–æ –≤–∏—Å—Ç–∞–≤–ª—è—Ç–∏ –∫–≤–∏—Ç–∫–∏ –∑ QR-–∫–æ–¥–æ–º —É —Å—Ç–æ—Ä—ñ–∑?", options: [{ text: "–ù—ñ, –∫–æ–¥ –º–æ–∂—É—Ç—å –≤–∫—Ä–∞—Å—Ç–∏", score: 2 }, { text: "–¢–∞–∫, –ø—Ä–æ—Å—Ç–æ –∫–∞—Ä—Ç–∏–Ω–∫–∞", score: 0 }] },
            { icon: "üîê", q: "–î—Ä—É–≥ –ø—Ä–æ—Å–∏—Ç—å –ø—Ä–æ–≥–æ–ª–æ—Å—É–≤–∞—Ç–∏ –∑–∞ –ø–æ—Å–∏–ª–∞–Ω–Ω—è–º —É –Ü–Ω—Å—Ç–∞–≥—Ä–∞–º. –î—ñ—ó?", options: [{ text: "–ó–ª–∞–º, –∑–∞–±–ª–æ–∫—É—é –¥–æ –≤—ñ–¥–Ω–æ–≤–ª–µ–Ω–Ω—è", score: 2 }, { text: "–ó–∞–ø–∏—Ç—É—é –π–æ–≥–æ —á–µ—Ä–µ–∑ —ñ–Ω—à—ñ —Å–µ—Ä–≤—ñ—Å–∏, —á–∏ –∑–∞—Ç–µ–ª–µ—Ñ–æ–Ω—É—é, —á–∏ –Ω–µ –≤–∑–ª–∞–º–∞–ª–∏ –π–æ–≥–æ", score: 2 }, { text: "–ó–≤—ñ—Å–Ω–æ, –¥–æ–ø–æ–º–æ–∂—É!", score: 0 }] },
            { icon: "üéÆ", q: "–ì—Ä–∞ '3-–≤-—Ä—è–¥' –ø—Ä–æ—Å–∏—Ç—å –¥–æ—Å—Ç—É–ø –¥–æ –∫–∞–º–µ—Ä–∏ —Ç–∞ –ª–æ–∫–∞—Ü—ñ—ó. –û–∫?", options: [{ text: "–ù—ñ, –∑–∞–±–ª–æ–∫—É—é –Ω–∞–¥–ª–∏—à–∫–æ–≤—ñ –¥–æ—Å—Ç—É–ø–∏", score: 2 }, { text: "–¢–∏–º—á–∞—Å–æ–≤–∏–π –¥–æ—Å—Ç—É–ø", score: 1 }, { text: "–¢–∞–∫. –ó–∞—Ä–∞–∑ –≤—Å—ñ —ñ–≥—Ä–∏ —Ç–∞–∫ —Ä–æ–±–ª—è—Ç—å", score: 0 }] },
            { icon: "ü§ñ", q: "–ß–∏ –º–æ–∂–Ω–∞ –¥–∞–≤–∞—Ç–∏ –®–Ü –æ—Å–æ–±–∏—Å—Ç—ñ –¥–∞–Ω—ñ –¥–ª—è –¥–æ–º–∞—à–∫–∏?", options: [{ text: "–ù—ñ, –¥–∞–Ω—ñ —Å—Ç–∞—é—Ç—å –ø—É–±–ª—ñ—á–Ω–∏–º–∏", score: 2 }, { text: "–í–∏–¥–∞–ª—é —á–∞—Ç –ø—ñ—Å–ª—è", score: 1 }, { text: "–¢–∞–∫, AI ‚Äî –º—ñ–π –¥—Ä—É–≥", score: 0 }] },
            { icon: "üßê", q: "–†–æ–∑—ñ–≥—Ä–∞—à iPhone 21 –∑–∞ 1000 –≥—Ä–Ω. –Ø–∫ –ø–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏?", options: [{ text: "–ü–µ—Ä–µ–≤—ñ—Ä—é URL —Ç–∞ –æ—Ñ—ñ—Ü—ñ–π–Ω—ñ –¥–∂–µ—Ä–µ–ª–∞", score: 2 }, { text: "–ü–µ—Ä–µ—à–ª—é –¥—Ä—É–∑—è–º", score: 1 }, { text: "–ö–ª—ñ–∫–Ω—É", score: 0 }] },
            { icon: "üåê", q: "–£ –∫–∞—Ñ–µ –∑ –≤—ñ–¥–∫—Ä–∏—Ç–∏–º Wi-Fi –±–µ–∑–ø–µ—á–Ω–æ –∑–∞—Ö–æ–¥–∏—Ç–∏ –≤ –æ–Ω–ª–∞–π–Ω –±–∞–Ω–∫?", options: [{ text: "–ù—ñ, –º–æ–∂—É—Ç—å –≤–∫—Ä–∞—Å—Ç–∏ –¥–∞–Ω—ñ", score: 2 }, { text: "–¢—ñ–ª—å–∫–∏ —è–∫—â–æ —î HTTPS", score: 1 }, { text: "–¢–∞–∫, –±–µ–∑–∫–æ—à—Ç–æ–≤–Ω–∏–π —ñ–Ω–µ—Ç!", score: 0 }] },
            { icon: "üì±", q: "–Ü–Ω—Ç–µ—Ä–Ω–µ—Ç - —Ü–µ?", options: [{ text: "–ö–∞–Ω–∞–ª –≤ –¢—ñ–∫-–¢–æ–∫", score: 0 }, { text: "–ì–ª–æ–±–∞–ª—å–Ω–∞ –ø–∞–≤—É—Ç–∏–Ω–Ω–∞ –º–µ—Ä–µ–∂–∞", score: 2 }, { text: "–ú–µ—Ä–µ–∂–∞ –º–∞—Ä–∫–µ—Ç—ñ–≤, –ø–æ—Ç–∏–ø—É –†–æ–∑–µ—Ç–∫–∏", score: 0 }] },
            { icon: "üõ°Ô∏è", q: "–©–æ —Ç–∞–∫–µ –∫—ñ–±–µ—Ä–≥—ñ–≥—ñ—î–Ω–∞?", options: [{ text: "–ú–∏—Ç–∏ —Ä—É–∫–∏ –ø—ñ–¥ –∫—ñ–±–µ—Ä–ø–∞–Ω–∫ –º–∞–∑–∏–∫—É", score: 0 }, { text: "–§—ñ–ª—å—Ç—Ä—É–≤–∞—Ç–∏ —Ç–µ –Ω–∞ —è–∫—ñ —Å–∞–π—Ç–∏ —Ö–æ–∂—É, —â–æ –¥–∏–≤–ª—é—Å—è, —Ç–∞ —â–æ –≤—Å—Ç–∞–Ω–æ–≤–ª—é—é", score: 2 }] },
            { icon: "üï∂Ô∏è", q: "–Ø–∫—â–æ —Ç–∏ –∑—Ç–∏–∫–Ω–µ—à—Å—è –∑ –±—É–ª—ñ–Ω–≥–æ–º?", options: [{ text: "–ü–æ–≤—ñ–¥–æ–º–ª—é –±–∞—Ç—å–∫—ñ–≤, —Ç–∞ –≤—á–∏—Ç–µ–ª—è –∑–∞ –ø–æ—Ä—Ç–µ–±–∏", score: 2 }, { text: "–ö–∏–Ω—É –≤ —ñ–≥–Ω–æ—Ä, –≤ –±–ª–æ–∫ –ª—ñ—Å—Ç, –Ω–∞–ø–∏—à—É —Å–∫–∞—Ä–≥—É –≤ —Å–∞–ø–ø–æ—Ä—Ç", score: 1 }, { text: "–ó–∞–±—É–ª—é —É –≤—ñ–¥–ø–æ–≤—ñ–ª—å", score: -1 }] },
            { icon: "üé≠", q: "–Ø–∫—â–æ —Ç–æ–±—ñ –ø–æ–≥—Ä–æ–∂—É—é—Ç—å –≤ –Ü–Ω—Ç–µ—Ä–Ω–µ—Ç—ñ?", options: [{ text: "–ü–æ–≤—ñ–¥–æ–º–ª—é –±–∞—Ç—å–∫—ñ–≤, –≤—á–∏—Ç–µ–ª—è —Ç–∞ –∑–∞ –ø–æ—Ä—Ç–µ–±–∏ –ø–æ–ª—ñ—Ü—ñ—é", score: 2 }, { text: "–ö–∏–Ω—É –≤ –±–ª–æ–∫ –ª—ñ—Å—Ç, –Ω–∞–ø–∏—à—É —Å–∫–∞—Ä–≥—É –≤ —Å–∞–ø–ø–æ—Ä—Ç", score: 1 }, { text: "–î–ê –¶–ï –Ø –¢–ï–ë–ï –ó–ê–†–ê–ó –ó–ù–ê–ô–î–£ –¢–ê....", score: -1 }] },
            { icon: "üì±", q: "–¢–µ–ª–µ—Ñ–æ–Ω –¥–∏–≤–Ω–æ —Å–µ–±–µ –ø–æ–≤–æ–¥–∏—Ç—å, —Å–∞–º –≤–º–∏–∫–∞—î—Ç—å—Å—è, –≥—Ä—ñ—î—Ç—å—Å—è —Ç–∞ —à–≤–∏–¥–∫–æ —Ä–æ–∑—Ä—è–¥–∂–∞—î—Ç—å—Å—è", options: [{ text: "–ú–æ–∂–ª–∏–≤–æ –≤—ñ—Ä—É—Å, —Å–∫–∞—á–∞—é –Ω–∞–≤—Å—è–∫ –≤–∏–ø–∞–¥–æ–∫ –∞–Ω—Ç–∏–≤—ñ—Ä—É—Å", score: 2 }, { text: "–í–∏–¥–∞–ª—é –∑–∞–π–≤—ñ –ø—Ä–æ–≥—Ä–∞–º–∏", score: 2 }, { text: "–Ø–∫–∏–π —Ç–µ–ø–ª–µ–Ω—å–∫–∏–π, –ø–æ–≥—Ä—ñ—î–º–æ —Ä—É—á–∫–∏", score: 0 }] },
            { icon: "üì±", q: "–í–∏ –ø–æ–±–∞—á–∏–ª–∏ —Ç—ñ–∫-—Ç–æ–∫ –¥–µ –∞–±—Å—É—Ä–¥–Ω–æ –∑–º–µ—Ä–∑–ª—ñ –¥–æ –ø–æ—Å–∏–Ω—ñ–Ω–Ω—è –ª—é–¥–∏ –∑–∞–∫–ª–∏–∫–∞—é—Ç—å –¥–æ –ø—Ä–æ—Ç–µ—Å—Ç—É —á–µ—Ä–µ–∑ –≤—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è!", options: [{ text: "–í–º–µ–≤–Ω–∏—Ç–∏—Å—å —â–æ —Ü–µ –Ω–µ –®–Ü —Ñ–µ–π–∫", score: 2 }, { text: "–õ–∞–π–∫!", score: 0 }, { text: "–ü—ñ–¥—Ç—Ä–∏–º–∞—Ç–∏ –ø—Ä–æ—Ç–µ—Å—Ç", score: 0 }] },
            { icon: "üì±", q: "–ü—Ä–∏–ª–µ—Ç—ñ–ª–∞ SMS –≤—ñ–¥ monobonk.ua, —â–æ –≤–∏ –≤–∏–≥—Ä–∞–ª–∏ –≤ –∫–æ–Ω–∫—É—Ä—Å—ñ –∫–µ—à–±–µ–∫+", options: [{ text: "–ó–∞–±–ª–æ–∫—É—é, –Ω–µ–ø–µ—Ä–µ—Ö–æ–¥—è—á—ñ –Ω—ñ–∫—É–¥–∏", score: 2 }, { text: "–¢–∏—Ü–Ω—É –ø–µ—Ä–µ–π—Ç–∏", score: 0 }, { text: "ü¶Ä–ú–∞–Ω—ñ –º–∞–Ω—ñ –º–∞–Ω—ñ!", score: 0 }] },
        ];

        const nicknamesData = {
            prefixes: ["–ö—ñ–±–µ—Ä", "–ù–µ–π—Ä–æ", "–ö–≤–∞–Ω—Ç–æ", "–ì–ª—ñ—á", "–¢–µ—Ö–Ω–æ", "–ö—Ä—ñ–ø—Ç–æ", "–ë—ñ–Ω–∞—Ä–Ω–∏–π", "–ú–µ—Ç–∞", "LoFi", "–Ü–ù–µ—Ç", "Cyber"],
            creatures: ["–ö—ñ—Ç", "–ë–æ—Ä—Å—É–∫", "–§–µ–Ω—ñ–∫—Å", "–î—Ä–∞–∫–æ–Ω", "–°–æ–≤–∞", "–í–æ–≤–∫", "–†–∏—Å—å", "–°–∞–ø—Å–∞–Ω", "–¢–∏–≥—Ä", "–ö–µ–Ω—Ç–∞–≤—Ä", "–ü–∞–≤—É–∫"]
        };

        let selectedQuestions = [];
        let currentStep = 0;
        let totalScore = 0;
        let attemptsLeft = parseInt(getCookie('cyberAttempts') || '1');

        // --- CORE FUNCTIONS ---
        async function loadData() {
            try {
                const res = await fetch(API_URL);
                const data = await res.json();
                const select = document.getElementById('team-select');
                
                if (data.allowed_teams) {
                    select.innerHTML = '<option value="">-- –û–ë–ï–†–ò –ö–û–ú–ê–ù–î–£ --</option>' + 
                        data.allowed_teams.map(t => `<option value="${t}">${t}</option>`).join('');
                }
                document.getElementById('player-list').innerHTML = data.players.map(l => `<div class="leader-item"><span>${l.nick}</span><b>${l.score}</b></div>`).join('');
                document.getElementById('team-list').innerHTML = data.teams.map(t => `<div class="leader-item"><span>${t.name}</span><b>${t.score}</b></div>`).join('');
            } catch (e) { console.error(e); }
        }

        window.onload = () => {
            loadData();
            const lastNick = getCookie('cyberNick');
            if (lastNick) {
                document.getElementById('welcome-container').innerHTML = `<div class="welcome-msg">–í—ñ—Ç–∞—é —Ö–∞–∫–µ—Ä–µ, <b style="color:var(--accent)">${lastNick}</b>! <br><span onclick="deleteProfile()" style="font-size:0.7rem; color:var(--error); cursor:pointer; text-decoration:underline;">–°–∫–∏–Ω—É—Ç–∏ –ø—Ä–æ—Ñ—ñ–ª—å</span></div>`;
            }
            document.getElementById('attempts-ui').innerText = `–°–ø—Ä–æ–±–∏: ${attemptsLeft} / 3`;
            if (attemptsLeft <= 0) {
                document.getElementById('start-btn').disabled = true;
                document.getElementById('start-btn').innerText = "–í–ò–ß–ï–†–ü–ê–ù–û";
            }
            initMatrix();
            setInterval(drawMatrix, 50);
        };

        async function startQuiz() {
            const team = document.getElementById('team-select').value;
            if (!team) return alert("–û–±–µ—Ä–∏ –∫–æ–º–∞–Ω–¥—É!");
            if (attemptsLeft <= 0) return;

            const nick = getCookie('cyberNick') || `${nicknamesData.prefixes[Math.floor(Math.random()*10)]}-${nicknamesData.creatures[Math.floor(Math.random()*9)]}`;
            setCookie('cyberNick', nick);
            setCookie('cyberTeam', team);

            // –ö–†–û–ö 1: –ü—Ä–∏—î–¥–Ω–∞–Ω–Ω—è –¥–æ —Å—Ç–æ–ª—É
            const res = await fetch(API_URL, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({action: 'join', nick, team})
            });

            if (res.ok) {
                document.getElementById('start-screen').classList.remove('active');
                document.getElementById('waiting-screen').classList.add('active'); // –¢–†–ï–ë–ê –î–û–î–ê–¢–ò –¶–ï–ô DIV –í HTML
                pollGameState();
            } else {
                alert("–ú—ñ—Å—Ü—å –∑–∞ —Ü–∏–º —Å—Ç–æ–ª–æ–º –±—ñ–ª—å—à–µ –Ω–µ–º–∞—î!");
            }
        }

        function pollGameState() {
            const interval = setInterval(async () => {
                const res = await fetch(API_URL);
                const data = await res.json();
                if (data.game_status === 'started') {
                    clearInterval(interval);
                    document.getElementById('waiting-screen').classList.remove('active');
                    document.getElementById('quiz-ui').classList.add('active');
                    selectedQuestions = allQuestions.sort(() => 0.5 - Math.random()).slice(0, 13);
                    showQuestion();
                }
            }, 2000);
        }

        function showQuestion() {
            const q = selectedQuestions[currentStep];
            document.getElementById('progress-fill').style.width = `${(currentStep / selectedQuestions.length) * 100}%`;
            const shuffled = [...q.options].sort(() => 0.5 - Math.random());
            document.getElementById('quiz-content').innerHTML = `
                <div style="font-size:3rem; margin-bottom:10px;">${q.icon}</div>
                <h2>${q.q}</h2>
                <div class="options">${shuffled.map(o => `<button onclick="handleAnswer(${o.score})">${o.text}</button>`).join('')}</div>
            `;
        }

        // –ù–æ–≤–∞ —Ñ—É–Ω–∫—Ü—ñ—è –≤ index.html
        async function joinTeam() {
            const team = document.getElementById('team-select').value;
            const nick = getCookie('cyberNick') || generateNick();
            
            const res = await fetch(API_URL, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({action: 'join', nick, team})
            });

            if(res.ok) {
                document.getElementById('start-screen').classList.remove('active');
                document.getElementById('waiting-screen').classList.add('active');
                startPollingStatus();
            } else {
                alert("–ó–∞ —Ü–∏–º —Å—Ç–æ–ª–æ–º –Ω–µ–º–∞—î –≤—ñ–ª—å–Ω–∏—Ö –º—ñ—Å—Ü—å!");
            }
        }

        function startPollingStatus() {
            const checkInterval = setInterval(async () => {
                const res = await fetch(API_URL);
                const data = await res.json();
                if(data.game_status === 'started') {
                    clearInterval(checkInterval);
                    runQuiz(); // –ü–æ—á–∞—Ç–æ–∫ –ø–∏—Ç–∞–Ω—å
                }
            }, 2000);
        }

        window.handleAnswer = (score) => {
            totalScore += score;
            currentStep++;
            if (currentStep < selectedQuestions.length) showQuestion();
            else finalizeGame();
        }

        async function finalizeGame() {
            // 1. –ó–º–µ–Ω—à—É—î–º–æ –∫—ñ–ª—å–∫—ñ—Å—Ç—å —Å–ø—Ä–æ–±
            attemptsLeft--;
            setCookie('cyberAttempts', attemptsLeft);

            // 2. –ü–µ—Ä–µ–º–∏–∫–∞—î–º–æ –µ–∫—Ä–∞–Ω–∏ —ñ–Ω—Ç–µ—Ä—Ñ–µ–π—Å—É
            document.getElementById('quiz-ui').classList.remove('active');
            document.getElementById('result-screen').classList.add('active');

            // 3. –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ –∞–±–æ —Å—Ç–≤–æ—Ä—é—î–º–æ –Ω—ñ–∫–Ω–µ–π–º
            let nick = getCookie('cyberNick');
            if (!nick) {
                nick = `${nicknamesData.prefixes[Math.floor(Math.random() * nicknamesData.prefixes.length)]}-${nicknamesData.creatures[Math.floor(Math.random() * nicknamesData.creatures.length)]}`;
                setCookie('cyberNick', nick);
            }

            // 4. –í—ñ–¥–æ–±—Ä–∞–∂–∞—î–º–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∏ –Ω–∞ –µ–∫—Ä–∞–Ω—ñ
            document.getElementById('nick-display').innerText = nick;
            document.getElementById('final-score').innerText = totalScore;

            // 5. –õ–æ–≥—ñ–∫–∞ –≤–∏—Å–Ω–æ–≤–∫—ñ–≤ (—Ä–∞–Ω–≥–∏)
            const box = document.getElementById('conclusion-box');
            if (totalScore >= 21) {
                box.innerHTML = `<b style="color:var(--accent)">üëë –õ–ï–ì–ï–ù–î–ê</b><br><small>–¢–≤—ñ–π –∑–∞—Ö–∏—Å—Ç –Ω–µ–ø—Ä–æ–±–∏–≤–Ω–∏–π! –¢–∏ ‚Äî —Ü–∏—Ñ—Ä–æ–≤–∞ –µ–ª—ñ—Ç–∞.</small>`;
            } else if (totalScore >= 16) {
                box.innerHTML = `<b style="color:var(--secondary)">‚öîÔ∏è –ó–ê–•–ò–°–ù–ò–ö</b><br><small>–¢–∏ –∑–Ω–∞—î—à –ø—Ä–∞–≤–∏–ª–∞ –≥—Ä–∏, –∞–ª–µ –≤–æ—Ä–æ–≥ –Ω–µ —Å–ø–∏—Ç—å. –ë—É–¥—å –ø–∏–ª—å–Ω–∏–º!</small>`;
            } else {
                box.innerHTML = `<b style="color:var(--error)">üê£ –°–ö–ê–£–¢</b><br><small>–¢–≤–æ—é –±—Ä–æ–Ω—é –ª–µ–≥–∫–æ –ø—Ä–æ–±–∏—Ç–∏. –ü–æ–≤–µ—Ä—Ç–∞–π—Å—è –ø—ñ—Å–ª—è —Ç—Ä–µ–Ω—É–≤–∞–Ω–Ω—è!</small>`;
            }

            // 6. –í–Ü–î–ü–†–ê–í–ö–ê –î–ê–ù–ò–• –ù–ê –ë–ï–ö–ï–ù–î
            try {
                await fetch(API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        action: 'finalize', // –ö–†–ò–¢–ò–ß–ù–û: –≤–∫–∞–∑—É—î–º–æ –¥—ñ—é –¥–ª—è —Å–µ—Ä–≤–µ—Ä–∞
                        nick: nick, 
                        score: totalScore, 
                        team: getCookie('cyberTeam') 
                    })
                });
            } catch (e) { 
                console.error("–ü–æ–º–∏–ª–∫–∞ —Å–∏–Ω—Ö—Ä–æ–Ω—ñ–∑–∞—Ü—ñ—ó –∑ —Å–µ—Ä–≤–µ—Ä–æ–º:", e); 
            }

            // 7. –û–Ω–æ–≤–ª—é—î–º–æ –ª—ñ–¥–µ—Ä–±–æ—Ä–¥, —â–æ–± –ø–æ–±–∞—á–∏—Ç–∏ —Å–µ–±–µ –≤ —Ç–æ–ø—ñ
            loadData();
        }

        // --- HELPERS ---
        function switchTab(t) {
            const isPl = t === 'pl';
            document.getElementById('t-pl').className = `tab-btn ${isPl ? 'active' : ''}`;
            document.getElementById('t-tm').className = `tab-btn ${!isPl ? 'active' : ''}`;
            document.getElementById('player-list').className = `lb-list ${isPl ? 'active' : ''}`;
            document.getElementById('team-list').className = `lb-list ${!isPl ? 'active' : ''}`;
        }

        function setCookie(n, v) { document.cookie = `${n}=${encodeURIComponent(v)}; max-age=${10*24*3600}; path=/; SameSite=Lax`; }
        function getCookie(n) { let m = document.cookie.match(new RegExp("(?:^|; )" + n.replace(/([\.$?*|{}\(\)\[\]\\\/\+^])/g, '\\$1') + "=([^;]*)")); return m ? decodeURIComponent(m[1]) : ""; }
        function deleteProfile() { if(confirm("–°–∫–∏–Ω—É—Ç–∏ –≤—Å–µ?")) { setCookie('cyberNick', '', -1); setCookie('cyberAttempts', '', -1); location.reload(); } }

        function initMatrix() {
            canvas.width = window.innerWidth; canvas.height = window.innerHeight;
            columns = canvas.width / 14; drops = Array(Math.floor(columns)).fill(1);
        }
        function drawMatrix() {
            ctx.fillStyle = "rgba(5, 11, 24, 0.1)"; ctx.fillRect(0, 0, canvas.width, canvas.height);
            for (let i = 0; i < drops.length; i++) {
                ctx.fillStyle = i % 2 === 0 ? "#00d2ff" : "#9d00ff";
                ctx.fillText("01"[Math.floor(Math.random()*2)], i*14, drops[i]*14);
                if (drops[i]*14 > canvas.height && Math.random() > 0.975) drops[i] = 0;
                drops[i]++;
            }
        }
    </script>
</body>
</html>